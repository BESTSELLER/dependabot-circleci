version: 2.1

orbs:
  secret-injector: bestsellerit/secret-injector@1.7.5
  cci-common: bestsellerit/cci-common@1.4.3
  google-sql-operations: bestsellerit/google-sql-operations@1.5.1

jobs:
  init-db:
    description: |
      Connects to database using cloud sql proxy and creates tabel using psql
    executor: cci-common/cloudsdk_image
    parameters:
      instance:
        description: The Cloud SQL instance to connect to
        type: string
      credential-file:
        description: Location of credential-file
        type: string
      project:
        description: Project name
        type: string
      username:
        description: User name
        type: string
      password:
        description: Password for user
        type: string
      db_name:
        description: Name of DB
        type: string
      init-file:
        description: File to use for initialising table
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - run:
          name: install jq
          command: |
            apk add --no-cache jq
      - run:
          name: gcloud login
          command: |
            cat /tmp/cloudrun_admin | jq -r .private_key_data | base64 -d > cloudrun-admin.json
            gcloud auth activate-service-account --key-file=./cloudrun-admin.json
      - run:
          name: Install Cloud SQL Proxy
          command: |
            source /tmp/secrets
            wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O /usr/bin/./cloud_sql_proxy
            chmod +x /usr/bin/./cloud_sql_proxy
      - run:
          name: Install psql
          command: |
            apk update
            apk --update add postgresql-client
      - run:
          name: Initalize DB with table
          command: |
            source /tmp/secrets
            HOST=$(gcloud sql instances describe "<< parameters.instance >>" --format="value(connectionName)" --project="<< parameters.project >>")
            cloud_sql_proxy -instances="$HOST"=tcp:5432 -credential_file="<< parameters.credential-file >>" &
            export PGPASSWORD="<< parameters.password >>"
            psql "host=127.0.0.1 sslmode=disable dbname="<< parameters.db_name >>" user="<< parameters.username >>" -f "<< parameters.init-file >>""
            

workflows:
  test:
    jobs:
      - secret-injector/dump-secrets-yaml:
          secret-file: ci-secrets.yaml
          context:
            - es02-prod
            - shared
          filters:
            tags:
              ignore: /^[0-9]+(\.[0-9]+)*(-.*)*$/
      - cci-common/go_test_unit:
          context:
            - shared
          filters:
            tags:
              ignore: /^[0-9]+(\.[0-9]+)*(-.*)*$/
      - cci-common/go_test_sonar:
          context:
            - es02-prod
            - shared
          requires:
            - secret-injector/dump-secrets-yaml
          filters:
            tags:
              ignore: /^[0-9]+(\.[0-9]+)*(-.*)*$/
      - cci-common/build_n_push_docker:
          dry_run: true
          requires:
            - secret-injector/dump-secrets-yaml
          context:
            - es02-prod
            - shared
          filters:
            tags:
              ignore: /^[0-9]+(\.[0-9]+)*(-.*)*$/
      - cci-common/terraform_plan:
          path: ./terraform
          args: '-var tag=1.0.0'
          lock: false
          context:
            - es02-prod
            - shared
          requires:
            - secret-injector/dump-secrets-yaml
          filters:
            tags:
              ignore: /^[0-9]+(\.[0-9]+)*(-.*)*$/
          pre-steps:
            - attach_workspace:
                at: /tmp
            - run:
                command: |
                  cat /tmp/cloudrun_admin | jq -r .private_key_data | base64 -d > /tmp/cloudrun-admin.json

  deploy:
    jobs:
      - secret-injector/dump-secrets-yaml:
          secret-file: ci-secrets.yaml
          context:
            - es02-prod
            - shared
          filters:
            tags:
              only: /^[0-9]+(\.[0-9]+)*(-.*)*$/
            branches:
              ignore: /.*/
      - cci-common/build_n_push_docker:
          tag: ${CIRCLE_TAG}
          repo: public-docker
          context:
            - es02-prod
            - shared
          requires:
            - secret-injector/dump-secrets-yaml
          filters:
            tags:
              only: /^[0-9]+(\.[0-9]+)*(-.*)*$/
            branches:
              ignore: /.*/
      - cci-common/terraform_plan:
          path: ./terraform
          args: '-var tag=${CIRCLE_TAG}'
          context:
            - es02-prod
            - shared
          requires:
            - cci-common/build_n_push_docker
          filters:
            tags:
              only: /^[0-9]+(\.[0-9]+)*(-.*)*$/
            branches:
              ignore: /.*/
          pre-steps:
            - attach_workspace:
                at: /tmp
            - run:
                command: |
                  cat /tmp/cloudrun_admin | jq -r .private_key_data | base64 -d > /tmp/cloudrun-admin.json
            - persist_to_workspace:
                root: /tmp
                paths:
                  - cloudrun-admin.json
      - cci-common/terraform_apply:
          path: ./terraform
          context:
            - es02-prod
            - shared
          requires:
            - cci-common/terraform_plan
          filters:
            tags:
              only: /^[0-9]+(\.[0-9]+)*(-.*)*$/
            branches:
              ignore: /.*/
      - init-db:
          instance: $instance
          db_name: $db_name
          project: dependabot-pub-prod-586e
          username: $username
          password: $password
          credential-file: /tmp/cloudrun-admin.json
          init-file: ./init.sql
          context:
            - es02-prod
            - shared
          requires:
            - cci-common/terraform_apply
          filters:
            tags:
              only: /^[0-9]+(\.[0-9]+)*(-.*)*$/
            branches:
              ignore: /.*/